<%@ page import="java.sql.*, java.time.LocalDate, java.time.format.DateTimeFormatter, java.time.temporal.ChronoUnit;" %>
<%
    // Récupération des paramètres de la requête
    String checkIn = request.getParameter("check_in");
    String checkOut = request.getParameter("check_out");
    String roomType = request.getParameter("room_type");
    double pricePerNight = 0.0;
    double totalAmount = 0.0;
    long diffInDays = 0;

    // Vérification des dates de séjour
    if (checkIn != null && checkOut != null) {
        try {
            DateTimeFormatter formatter = DateTimeFormatter.ofPattern("yyyy-MM-dd");

            // Conversion des dates
            LocalDate checkInLocalDate = LocalDate.parse(checkIn, formatter);
            LocalDate checkOutLocalDate = LocalDate.parse(checkOut, formatter);

            // Calcul de la différence en jours
            diffInDays = ChronoUnit.DAYS.between(checkInLocalDate, checkOutLocalDate);

            if (diffInDays > 0) {
                if (roomType != null) {
                    switch (roomType) {
                        case "Chambre vue jardin":
                            pricePerNight = 100.0;
                            break;
                        case "Chambre vue de mer":
                            pricePerNight = 180.0;
                            break;
                        case "Bungalow":
                            pricePerNight = 250.0;
                            break;
                        default:
                            out.println("Type de chambre non valide.");
                            break;
                    }
                }
                totalAmount = diffInDays * pricePerNight;
            } else {
                out.println("La date de départ doit être après la date d'arrivée.");
            }
        } catch (Exception e) {
            out.println("Erreur lors du calcul des dates : " + e.getMessage());
        }
    }

    // Insertion de la réservation dans la base de données
    if (checkIn != null && checkOut != null && roomType != null && pricePerNight > 0 && totalAmount > 0) {
        String insertSQL = "INSERT INTO Reservation (guest_first_name, guest_last_name, guest_email, guest_phone, check_in_date, check_out_date, room_type_id) VALUES (?, ?, ?, ?, ?, ?, ?)";

        // Connexion à la base de données et insertion des données
        try (Connection conn = DriverManager.getConnection("jdbc:mysql://localhost:3306/hotel_management", "root", "password");
             PreparedStatement stmt = conn.prepareStatement(insertSQL)) {

            // Informations du client (exemples fixes ici)
            stmt.setString(1, "Jean");  // Prénom
            stmt.setString(2, "Dupont");  // Nom
            stmt.setString(3, "jean.dupont@example.com");  // Email
            stmt.setString(4, "0123456789");  // Numéro de téléphone
            stmt.setString(5, checkIn);  // Date d'arrivée
            stmt.setString(6, checkOut);  // Date de départ

            // Recherche de l'ID du type de chambre
            String roomTypeQuery = "SELECT id FROM RoomType WHERE label = ? LIMIT 1";
            try (PreparedStatement roomStmt = conn.prepareStatement(roomTypeQuery)) {
                roomStmt.setString(1, roomType);
                try (ResultSet rs = roomStmt.executeQuery()) {
                    if (rs.next()) {
                        int roomTypeId = rs.getInt("id");
                        stmt.setInt(7, roomTypeId);  // ID du type de chambre

                        // Exécution de l'insertion
                        int rowsAffected = stmt.executeUpdate();
                        if (rowsAffected > 0) {
                            out.println("Réservation effectuée avec succès !<br>");
                            out.println("Détails de la réservation :<br>");
                            out.println("Nom : Jean Dupont<br>");
                            out.println("Email : jean.dupont@example.com<br>");
                            out.println("Type de chambre : " + roomType + "<br>");
                            out.println("Date d'arrivée : " + checkIn + "<br>");
                            out.println("Date de départ : " + checkOut + "<br>");
                            out.println("Prix par nuit : " + pricePerNight + " DT<br>");
                            out.println("Durée du séjour : " + diffInDays + " jours<br>");
                            out.println("Montant total : " + totalAmount + " DT<br>");
                        } else {
                            out.println("Échec de la réservation.");
                        }
                    } else {
                        out.println("Le type de chambre sélectionné est invalide.");
                    }
                }
            }

        } catch (SQLException e) {
            out.println("Erreur lors de l'enregistrement de la réservation : " + e.getMessage());
        }
    } else {
        out.println("Veuillez remplir tous les champs correctement.");
    }
%>

